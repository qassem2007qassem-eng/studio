
/**
 * @fileoverview Firestore Security Rules for the Syrian Student Hub application.
 *
 * Core Philosophy:
 * This ruleset enforces a follower-based privacy model. Users can only see full profile details
 * and posts of users they follow. Public profiles have limited visibility.
 *
 * Data Structure & Rules Summary:
 * - /users/{userId}: Stores user profiles.
 *   - GET: A user's own profile is always readable. Public, limited data is readable by anyone. Full data is readable only by followers.
 *   - LIST: Allowed for searching users by username.
 *   - WRITE: Only the owner can write to their own profile.
 * - /posts/{postId}: Stores posts. Read access is controlled by the author's privacy settings (not yet implemented, so public for now). Write access is restricted to the author.
 * - /follows/{followId}: Manages follow relationships. Authenticated users can create/delete their own follow documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Checks if the current user is following the target user.
     * @param {string} targetUserId The UID of the user to check if they are being followed.
     * @return {boolean} True if the current user follows the target user.
     */
    function isFollowing(targetUserId) {
      return exists(/databases/$(database)/documents/follows/$(request.auth.uid)_$(targetUserId));
    }

    /**
     * @description User profiles. Read access is conditional.
     * @path /users/{userId}
     * @allow get: Anyone can get a user document to check basic info. More detailed rules could be applied to the data itself.
     * @allow list: Signed-in users can list/query users (e.g., for search).
     * @allow create, update, delete: Only the user themselves can manage their profile.
     */
    match /users/{userId} {
      allow get: if true; // Allows fetching a document to check existence and basic public data.
      allow list: if isSignedIn(); // Allow querying/listing for signed-in users (for search).
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Posts. Publicly readable for now.
     * @path /posts/{postId}
     */
    match /posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && (
            (resource.data.authorId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'imageUrl', 'updatedAt'])) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeIds'])
        );
        allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Comments. Publicly readable.
     * @path /posts/{postId}/comments/{commentId}
     */
    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid && request.resource.data.postId == postId;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
    
    /**
     * @description Follow relationships. Managed by the follower.
     * @path /follows/{followId}
     * @allow read: Any signed-in user can read follow relationships (e.g., to check "is following?").
     * @allow create: The user initiating the follow (follower) can create the document.
     * @allow delete: The user who initiated the follow (follower) can delete it.
     */
    match /follows/{followId} {
        allow read: if isSignedIn();
        // The followId must be in the format 'followerId_followeeId'
        allow create: if isSignedIn() && request.resource.data.followerId == request.auth.uid && followId == request.resource.data.followerId + '_' + request.resource.data.followeeId;
        allow delete: if isSignedIn() && resource.data.followerId == request.auth.uid;
        allow update: if false; 
    }

    /**
     * @description User-specific notifications.
     * @path /users/{userId}/notifications/{notificationId}
     */
    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Reports. Write-only for signed-in users.
     * @path /reports/{reportId}
     */
    match /reports/{reportId} {
      allow read, list, update, delete: if false;
      allow create: if isSignedIn();
    }
    
    /**
     * @description Stories. Publicly readable.
     * @path /stories/{storyId}
     */
    match /stories/{storyId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description User-specific summaries.
     * @path /users/{userId}/summaries/{summaryId}
     */
    match /users/{userId}/summaries/{summaryId} {
      allow read, write: if isOwner(userId);
    }
  }
}
